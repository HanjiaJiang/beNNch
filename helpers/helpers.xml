<?xml version="1.0" encoding="UTF-8"?>
<jube>

    <!-- Load jobfile -->
    <fileset name="files">
      <copy>${job_file}.in</copy>
    </fileset>
    
    <!-- Substitute jobfile -->
    <substituteset name="sub_bench_job">
      <iofile in="${job_file}.in" out="$job_file" />
      <sub source="#PARTITION#" dest="$partition_" />
      <sub source="#NODES#" dest="$nodes" />
      <sub source="#NTASKS#" dest="$num_tasks_tot" />
      <sub source="#NTASKS_PER_NODE#" dest="$ppn" />
      <sub source="#CPUS_PER_TASK#" dest="$cpus_per_task" />
      <sub source="#TIME#" dest="$walltime_" />
      <sub source="#ERRPATH#" dest="$err_file" />
      <sub source="#OUTPATH#" dest="$out_file" />
      <sub source="#COMMANDS#" dest="$exec" />
      <sub source="#READY#" dest="$ready_file" />
      <sub source="#JOB_NAME#" dest="$job_name" />
      <sub source="#ACCOUNT#" dest="$account" />
    </substituteset> 

    <parameterset name="slurm">
      <parameter name="submit_cmd">sbatch</parameter>
      <parameter name="job_file">job.slurm</parameter>
      <parameter name="nodes" type="int">$num_nodes</parameter>
      <parameter name="num_vps" type="int" mode="python">$vps_per_node*$num_nodes</parameter>
      <parameter name="num_tasks_tot" type="int" mode="python">${num_vps} // ${threads_per_task}</parameter>
      <parameter name="ppn" type="int" mode="python">${num_tasks_tot} // ${num_nodes}</parameter>
      
      <!-- next is alias to make result table template work -->
      <parameter name="tasks_per_node" type="int">${ppn}</parameter>
      <parameter name="cpus_per_task" type="int">$threads_per_task</parameter>
      <parameter name="totVPs" type="int" mode="python">$num_vps</parameter>
      <parameter name="walltime_">$walltime</parameter>
      <parameter name="ready_file">ready</parameter>
      <parameter name="err_file">stderr</parameter>
      <parameter name="out_file">stdout</parameter>
      <parameter name="partition_">$partition</parameter>
    </parameterset>

    <parameterset name="run_benchmark">
      <parameter name="job_name" type="string">benchmark</parameter>
      <parameter name="exec" separator=";">
        module load $modules
        
        export OMP_NUM_THREADS=$threads_per_task

        ${optional_run_command}
       
        srun ${affinity} python ${run_file} ${run_args}
        echo ${base_path}/helpers/collect_timer_data.py
        echo ${log_path}

        srun -n 1 python ${base_path}/helpers/collect_timer_data.py ${log_path}

        srun -n 1 python ${base_path}/helpers/cpu_logging.py ${jube_wp_abspath}
        srun -n 1 python ${base_path}/helpers/job_logging.py ${jube_wp_abspath} ${vps_per_node} ${num_nodes} ${tasks_per_node} ${threads_per_task} ${modules} ${model_name} ${network_state} ${record_spikes} ${affinity}
        srun -n 1 python ${base_path}/helpers/backup_logging.py ${jube_wp_abspath}
      </parameter>
    </parameterset>

    <parameterset name="no_optional_run_command">
      <parameter name="optional_run_command">
      </parameter>
    </parameterset>

    <!-- experiment configuration -->
    <parameterset name="scaling_experiment">
      <parameter name="weak_scaling" type="float">${scale_N}</parameter>
      <parameter name="strong_scaling" type="float" mode="python">${scale_N}*${num_nodes}</parameter>
    </parameterset>

    <patternset name="timer_pattern">
        <pattern mode="pattern" name="wall_time_sim" type="float">time_simulate $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_create" type="float">time_construction_create $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_connect" type="float">time_construction_connect $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_phase_collocate" type="float">time_collocate_spike_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_phase_communicate" type="float">time_communicate_spike_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_phase_deliver" type="float">time_deliver_spike_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_phase_update" type="float">time_update $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_communicate_target_data" type="float">time_communicate_target_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_gather_spike_data" type="float">time_gather_spike_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_gather_target_data" type="float">time_gather_target_data $jube_pat_fp</pattern>
        <pattern mode="pattern" name="wall_time_communicate_prepare" type="float">time_communicate_prepare $jube_pat_fp</pattern>
        <pattern name="py_time_kernel_prepare" type="float" dotall="True" mode="pattern">py_time_kernel_prepare $jube_pat_fp</pattern>
        <pattern name="py_time_network_local" type="float" dotall="True" mode="pattern">py_time_network_local $jube_pat_fp</pattern>
        <pattern name="py_time_network_global" type="float" dotall="True" mode="pattern">py_time_network_global $jube_pat_fp</pattern>
        <pattern name="py_time_simulate" type="float" dotall="True" mode="pattern">py_time_simulate $jube_pat_fp</pattern>
        <pattern name="py_time_presimulate" type="float" dotall="True" mode="pattern">py_time_presimulate $jube_pat_fp</pattern>
        <pattern name="py_time_network_prepare" type="float" dotall="True" mode="pattern">py_time_network_prepare $jube_pat_fp</pattern>
        <pattern name="py_time_create" type="float" dotall="True" mode="pattern">py_time_create $jube_pat_fp</pattern>
        <pattern name="py_time_connect_area" type="float" dotall="True" mode="pattern">py_time_connect_area $jube_pat_fp</pattern>
        <pattern name="py_time_connect_cc" type="float" dotall="True" mode="pattern">py_time_connect_cc $jube_pat_fp</pattern>
        <pattern name="py_time_connect" type="float" dotall="True" mode="pattern">py_time_connect $jube_pat_fp</pattern>
        <pattern name="base_memory" type="float" dotall="True" mode="pattern">base_memory $jube_pat_fp</pattern>
        <pattern name="network_memory" type="float" dotall="True" mode="pattern">network_memory $jube_pat_fp</pattern>
        <pattern name="init_memory" type="float" dotall="True" mode="pattern">init_memory $jube_pat_fp</pattern>
        <pattern name="total_memory" type="float" dotall="True" mode="pattern">total_memory $jube_pat_fp</pattern>
        <pattern name="num_connections" type="float" dotall="True" mode="pattern">num_connections $jube_pat_fp</pattern>
        <pattern name="local_spike_counter" type="float" dotall="True" mode="pattern">local_spike_counter $jube_pat_fp</pattern>
        <pattern name="e_counter" type="float" dotall="True" mode="pattern">e_counter $jube_pat_fp</pattern>
    </patternset>

</jube>
