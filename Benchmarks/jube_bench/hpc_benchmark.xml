<?xml version="1.0" encoding="UTF-8"?>
<jube>

  <!-- HPC Benchmark -->

  <include-path>
    <path>../jube_config/</path>
  </include-path>


  <benchmark name="HPC" outpath="../../../BenchWork/jube_hpc/nest_2_20_1">

    <parameterset name="global">
      <parameter name="base_path" type="string"></parameter>
      <parameter name="account" type="string"></parameter>
      <parameter name="email_address" type="string"></parameter>
      <parameter name="run_file" type="string">
        ${bench_model}/benchmark-models/hpc_benchmark/hpc_benchmark.sli
      </parameter>
      <parameter name="language">nest</parameter>  <!-- either nest or python -->
      <parameter name="modules">nest-simulator/2.20.1/default</parameter>
      <parameter name="PARTITION"></parameter>
    </parameterset>

    <parameterset name="scale_check">
      <parameter name="base_vp" type="int">64</parameter>
      <parameter name="base_scale" type="float">20</parameter>
      <parameter name="WALLTIME" type="string">00:30:00</parameter>
      <parameter name="NUMBER_OF_NODES" type="int">2</parameter>
      <parameter name="NUM_VPS" type="int" mode="python">$base_vp*$NUMBER_OF_NODES</parameter>
      <parameter name="THREADS_PER_TASK" type="int">6</parameter>
      <parameter name="SCALE" type="int" mode="python">$base_scale*$NUMBER_OF_NODES</parameter>
      <parameter name="SIMTIME" type="float">1000</parameter>
      <parameter name="NUM_REC" type="int">1000</parameter>
      <parameter name="PLASTIC" type="string">true</parameter>
      <parameter name="D_MIN" type="float">1.5</parameter>
      <parameter name="D_MAX" type="float">1.5</parameter>
    </parameterset>

    <!-- This subsituteset maps the parameters defined in the xml
         file(s) to the target patterns that JUBE will search for in the
         benchmark files. -->
    <substituteset name="simulation_substitutions">
      <iofile in="$run_file" out="$run_file" />
      <sub source="{scale}" dest="$SCALE" />
      <sub source="{totVPs}" dest="$totVPs" />
      <sub source="{simtime}" dest="$SIMTIME" />
      <sub source="{num_rec}" dest="$NUM_REC" />
      <sub source="{plastic}" dest="$PLASTIC" />
      <sub source="{d_min}" dest="$D_MIN" />
      <sub source="{d_max}" dest="$D_MAX" />
    </substituteset>

    <step name="bench">
      <use>global</use>
      <use from="dir_config.xml">dir_config</use>
      <use from="bench_jobs.xml">slurm,run_benchmark,files,sub_bench_job</use>
      <use>scale_check</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_scale_check">
      <use from="bench_jobs.xml">nest_pattern_stdcout</use>      <!-- use existing patternset -->
      <analyse step="bench">
        <file>stdout</file>        <!-- file which should be scanned -->
      </analyse>
    </analyser>

    <!-- Create result table -->
    <result>
      <use>analyse_scale_check</use>      <!-- use existing analyser -->
      <table name="NEST_HPC" style="csv" sort="number">
        <column>git</column>
        <column>NUMBER_OF_NODES</column>
        <column>TASKS_PER_NODE</column>
        <column>THREADS_PER_TASK</column>
        <column>num_tasks</column>
        <column>NUM_VPS</column>
        <column>SCALE</column>
        <column>PLASTIC</column>
        <column>T_nrns</column>
        <column>T_conns_min</column>
        <column>T_conns_max</column>
        <column>T_conns_sum</column>
        <column>T_ini_min</column>
        <column>T_ini_max</column>
        <column>T_equ</column>
        <column>T_sim</column>
        <column>VSize_nodes_sum</column>
        <column>VSize_mem_sum</column>
        <column>VSize_ini_sum</column>
        <column>VSize_sum</column>
        <column>N_spks_sum</column>
        <column>Rate_sum</column>
        <column>N_nrns</column>
        <column>N_conns_sum</column>
        <column>d_min</column>
        <column>d_max</column>
      </table>
    </result>


  </benchmark>
</jube>
