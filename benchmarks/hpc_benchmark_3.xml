<?xml version="1.0" encoding="UTF-8"?>
<jube>

  <include-path>
    <path>../helpers/</path>
    <path>../config/</path>
  </include-path>

  <!-- model-specific name and output path -->
  <benchmark name="HPC" outpath="../../benchmark_results/HPC/nest_3">

    <!-- model configuration -->
    <parameterset name="model_commands">
      <parameter name="run_file" type="string">${jube_wp_abspath}/hpc_benchmark_3.py</parameter>
      <parameter name="log_path" type="string">${jube_wp_abspath}</parameter>
    </parameterset>

     <!-- load and copy model-specific files -->
    <fileset name="model_files"> <!-- -->
      <copy>$model_path/hpc_benchmark_3.py</copy>
    </fileset>

    <!-- This subsituteset maps the parameters that were defined in this xml
         file to the target patterns that JUBE will search for in the
         simulation files. The pattern file is hpc_benchmark.py. The
         source pattern will be replaced by the values. -->
    <substituteset name="model_substitutions">
      <iofile in="hpc_benchmark_3.py" out="hpc_benchmark_3.py"/>
      <sub source="{num_vps}" dest="$num_vps"/>
      <sub source="{record_spikes}" dest="$record_spikes"/>
      <sub source="{model_time_sim}" dest="$model_time_sim"/>
      <sub source="{model_time_presim}" dest="$model_time_presim"/>
      <sub source="{N_SCALING}" dest="$scale_N"/>
    </substituteset>

    <!-- benchmark step -->
    <step name="bench">
      <use>model_commands, model_files, model_substitutions</use>
      <use from="user_config.xml">user_config</use>
      <use from="hpc_benchmark_3_config.xml">file_paths,model_parameters,machine_parameters</use>
      <use from="helpers.xml">slurm,run_benchmark,files,sub_bench_job,scaling_experiment</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- analysis step -->
    <analyser name="analyse">
      <use from="helpers.xml">timer_pattern</use>
      <analyse step="bench">
        <file>timer_data.txt</file>
      </analyse>
    </analyser>

    <!-- result step -->
    <result name="result">
      <use>analyse</use>
      <table name="result_table" style="csv" sort="number">
        <column>rng_seed</column>
        <column>num_nodes</column>
        <column>threads_per_task</column>
        <column>tasks_per_node</column>
        <column>model_time_sim</column>
        <column>wall_time_create</column>
        <column>wall_time_connect</column>
        <column>wall_time_sim</column>
        <column>wall_time_phase_collocate</column>
        <column>wall_time_phase_communicate</column>
        <column>wall_time_phase_deliver</column>
        <column>wall_time_phase_update</column>
        <column>wall_time_communicate_target_data</column>
        <column>wall_time_gather_spike_data</column>
        <column>wall_time_gather_target_data</column>
        <column>wall_time_communicate_prepare</column>
        <column>py_time_kernel_prepare</column>
        <column>py_time_network_local</column>
        <column>py_time_network_global</column>
        <column>py_time_simulate</column>
        <column>py_time_presimulate</column>
        <column>py_time_network_prepare</column>
        <column>py_time_create</column>
        <column>py_time_connect_area</column>
        <column>py_time_connect_cc</column>
        <column>py_time_connect</column>
        <column>base_memory</column>
        <column>network_memory</column>
        <column>init_memory</column>
        <column>total_memory</column>
        <column>num_connections</column>
        <column>local_spike_counter</column>
        <column>e_counter</column>
      </table>
    </result>

  </benchmark>
</jube>
